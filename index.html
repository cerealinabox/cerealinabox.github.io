<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Public Transportation Ridership in Singapore</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
  :root{
    --bg:#0b1020; --fg:#eef2ff; --muted:rgba(255,255,255,.72);
    --border:rgba(255,255,255,.14);
    --accent: rgba(92,108,255,.95);
    --accentSoft: rgba(92,108,255,.22);
  }

  html, body{ height:100%; }
  body{
    margin:0;
    background:var(--bg);
    color:var(--fg);
    font-family:system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;

    /* no-scroll layout */
    display:flex;
    flex-direction:column;
    overflow:hidden;
  }

  header, footer{
    max-width:980px;
    margin:0 auto;
    padding:12px 18px;
    text-align:center;
  }
  h1{ margin:6px 0 6px; font-size:36px; font-weight:800; }
  .subtitle{ margin:0; color:var(--muted); font-size:14px; }

  .wrap{
    max-width:980px;
    margin:0 auto;
    padding:10px 18px 12px;
    flex:1;
    min-height:0;
    display:flex;
    flex-direction:column;
    gap:12px;
  }

  /* Tabs at top */
  .tabs{
    background:rgba(255,255,255,.04);
    border:1px solid var(--border);
    border-radius:18px;
    padding:12px;
    flex:0 0 auto;
    backdrop-filter: blur(6px);
  }
  .tablist{ display:flex; gap:10px; flex-wrap:wrap; justify-content:center; padding:4px; }
  .tab{
    appearance:none;
    border:1px solid rgba(255,255,255,.18);
    background:transparent;
    color:var(--fg);
    padding:10px 14px;
    border-radius:999px;
    cursor:pointer;
    font-weight:650;
    font-size:14px;
  }
  .tab[aria-selected="true"]{
    border-color: var(--accent);
    background: var(--accentSoft);
  }
  .panel{
    margin-top:10px;
    background:rgba(255,255,255,.06);
    border:1px solid var(--border);
    border-radius:16px;
    padding:12px 14px;
    display:none;
    text-align:left;
  }
  .panel.active{ display:block; }
  .kicker{ font-size:11px; text-transform:uppercase; letter-spacing:.08em; opacity:.7; margin:0 0 6px; }
  h2{ margin:0 0 8px; font-size:18px; }
  p{ margin:0; color:var(--muted); line-height:1.45; font-size:13px; }

  /* Chart card fills remaining height */
  #chart-card{
    position:relative;
    width:100%;
    background:rgba(255,255,255,.06);
    border:1px solid var(--border);
    border-radius:18px;
    padding:12px;
    backdrop-filter: blur(6px);

    flex:1;
    min-height:0;
    display:flex;
    flex-direction:column;
    gap:8px;
  }

  #chart-title{ font-weight:750; font-size:13px; margin:0; text-align:left; }
  #chart-subtitle{ font-size:12px; opacity:.78; margin:0; text-align:left; }
  #chart-hint{ font-size:12px; opacity:.62; margin:0; text-align:left; }

  /* Summary window (top-right) */
  #summary{
    position:absolute;
    top:10px;
    right:10px;
    width:min(340px, 44vw);
    background: rgba(0,0,0,.42);
    border:1px solid rgba(255,255,255,.16);
    border-radius:14px;
    padding:10px;
    z-index:25;
    pointer-events:none;
  }
  #summary .ttl{
    font-size:12px;
    font-weight:800;
    opacity:.95;
    margin:0 0 6px;
  }
  #summary .row{
    display:flex;
    gap:8px;
    align-items:flex-start;
    margin:2px 0;
    font-size:12px;
    line-height:1.3;
    color: rgba(255,255,255,.88);
  }
  #summary .dim{ opacity:.72; }
  #summary .swatch{
    width:10px; height:10px; border-radius:3px;
    border:1px solid rgba(255,255,255,.22);
    flex: 0 0 auto;
    margin-top:3px;
  }

  /* Custom legend */
  #legend{
    display:flex;
    gap:8px;
    flex-wrap:wrap;
    margin:4px 0 2px;
    justify-content:flex-start;
  }
  .leg-btn{
    appearance:none;
    border:1px solid rgba(255,255,255,.18);
    background:rgba(255,255,255,.04);
    color:rgba(255,255,255,.9);
    padding:6px 10px;
    border-radius:999px;
    cursor:pointer;
    font-size:12px;
    display:flex;
    align-items:center;
    gap:8px;
    user-select:none;
    transition: transform .08s ease, background .12s ease, border-color .12s ease;
  }
  .leg-btn:hover{ transform: translateY(-1px); border-color: rgba(255,255,255,.35); }
  .leg-btn.active{
    border-color: var(--accent);
    background: var(--accentSoft);
  }
  .swatch{
    width:10px; height:10px; border-radius:3px;
    border:1px solid rgba(255,255,255,.25);
    display:inline-block;
  }

  /* make canvas fill height */
  #chart{
    flex:1;
    min-height:0;
    width:100% !important;
    height:100% !important;
    display:block;
  }

  .timeline{
    padding:8px 10px;
    border-radius:14px;
    background:rgba(255,255,255,.04);
    border:1px solid var(--border);
    display:flex;
    gap:10px;
    align-items:center;
    flex-wrap:wrap;
    flex:0 0 auto;
  }
  .year-pill{
    font-size:12px;
    padding:6px 10px;
    border-radius:999px;
    background:rgba(255,255,255,.08);
    border:1px solid rgba(255,255,255,.14);
    min-width:86px;
    text-align:center;
  }
  input[type="range"]{
    flex:1;
    min-width:220px;
    accent-color: rgb(92,108,255);
  }
  .mini{ font-size:12px; color:rgba(255,255,255,.65); }

  footer{ font-size:12px; color:rgba(255,255,255,.6); }
  code{ background:rgba(255,255,255,.08); padding:2px 6px; border-radius:8px; }
</style>
</head>

<body>
<header>
  <h1>Public Transportation Ridership In Singapore</h1>
  <p class="subtitle">Interact to learn more about public transportation ridership from 2000 - 2025</p>
</header>

<div class="wrap">

  <div class="tabs" role="region" aria-label="Chapters">
    <div class="tablist" role="tablist" aria-label="Chapters">
      <button class="tab" role="tab" aria-selected="true"  data-state="baseline">Travel Intensity</button>
      <button class="tab" role="tab" aria-selected="false" data-state="modes">Mode Split</button>
      <button class="tab" role="tab" aria-selected="false" data-state="system">Growth Race</button>
    </div>

    <div class="panel active" id="panel-baseline">
      <div class="kicker">Travel Intensity</div>
      <h2>How busy is daily travel?</h2>
      <p>Trips per 100 people per day, with population shown on a second axis for context.</p>
    </div>

    <div class="panel" id="panel-modes">
      <div class="kicker">Mode Split</div>
      <h2>Bus vs rail: who takes what share?</h2>
      <p>100% stacked share view: MRT+LRT vs Bus. Bus fill has no “100% ceiling stroke”. Crosshair snaps to the nearest year.</p>
    </div>

    <div class="panel" id="panel-system">
      <div class="kicker">Growth Race</div>
      <h2>What grew faster: total, rail, or bus demand?</h2>
      <p>Indexed growth since 2000 (2000 = 100). Comparing total ridership vs rail ridership vs bus ridership.</p>
    </div>
  </div>

  <div id="chart-card">
    <div id="summary" aria-label="Summary">
      <div class="ttl" id="sumTitle">Year: —</div>
      <div id="sumBody"></div>
    </div>

    <div id="chart-title"></div>
    <div id="chart-subtitle"></div>
    <div id="chart-hint">Move mouse over chart to interact.</div>

    <div id="legend" aria-label="Legend"></div>

    <canvas id="chart"></canvas>

    <div class="timeline" aria-label="Timeline scrubber">
      <div class="year-pill" id="yearPill">Year: —</div>
      <input id="yearSlider" type="range" min="0" max="0" value="0" step="1" aria-label="Select year"/>
      <div class="mini">Drag to pin. Click chart to jump.</div>
    </div>
  </div>

</div>

<footer>
  Source: data.gov.sg · Built with HTML, JavaScript, Chart.js · Debug: <code>window.app</code>
</footer>

<script type="application/json" id="DATA">
{
  "years":[2000,2001,2002,2003,2004,2005,2006,2007,2008,2009,2010,2011,2012,2013,2014,2015,2016,2017,2018,2019,2020,2021,2022,2023,2024],
  "population":[4027887,4138012,4175950,4114826,4166664,4265762,4401365,4588599,4839396,4987573,5076732,5183688,5312437,5399162,5469724,5535002,5607283,5612253,5638676,5703569,5685807,5453566,5637022,5917648,6036860],
  "rail":[1086000,1112000,1120000,1221000,1325000,1390000,1482000,1606000,1786000,1872000,2169000,2406000,2649000,2755000,2899000,3023000,3275000,3312000,3501000,3592000,2162000,2251000,2929000,3445000,3622000],
  "bus":[3251000,3281000,3197000,2992000,2805000,2779000,2833000,2932000,3087000,3047000,3199000,3385000,3481000,3601000,3751000,3891000,3939000,3952000,4037000,4099000,2878000,3008000,3461000,3747000,3837000],
  "total":[4337000,4393000,4317000,4213000,4130000,4169000,4315000,4538000,4873000,4919000,5268000,5791000,6129000,6356000,6650000,6914000,7214000,7264000,7708000,7791000,4160000,4259000,6390000,7192000,7459000]
}
</script>

<script>
(() => {
  const D = JSON.parse(document.getElementById("DATA").textContent);
  const years = D.years;
  const pop = D.population;
  const rail = D.rail;
  const bus = D.bus;
  const total = D.total;

  const titleEl = document.getElementById("chart-title");
  const subtitleEl = document.getElementById("chart-subtitle");
  const legendEl = document.getElementById("legend");

  const slider = document.getElementById("yearSlider");
  const yearPill = document.getElementById("yearPill");

  const sumTitle = document.getElementById("sumTitle");
  const sumBody = document.getElementById("sumBody");

  slider.min = 0;
  slider.max = String(years.length - 1);
  slider.value = String(years.length - 1);

  // ---------- helpers ----------
  const fmtInt = (n) => (n==null || Number.isNaN(n)) ? "n/a" : new Intl.NumberFormat().format(Math.round(n));
  const fmt1 = (n) => (n==null || Number.isNaN(n)) ? "n/a" : Number(n).toFixed(1);
  const fmt2 = (n) => (n==null || Number.isNaN(n)) ? "n/a" : Number(n).toFixed(2);

  const indexTo100 = (arr) => {
    const base = arr.find(v => v!=null);
    return arr.map(v => (v==null || base==null || base===0) ? null : (v/base)*100);
  };

  const tripsPer100 = total.map((v,i)=> (v!=null && pop[i]!=null && pop[i]!==0) ? (v/pop[i])*100 : null);

  function extent(arr){
    const vals = arr.filter(v => v!=null && !Number.isNaN(v));
    let mn = Math.min(...vals), mx = Math.max(...vals);
    if (mn === mx) { mn -= 1; mx += 1; }
    const pad = (mx - mn) * 0.08;
    return {min: mn - pad, max: mx + pad};
  }

  // ---------- Crosshair plugin (X only) ----------
  const crosshair = {
    id: "crosshair",
    afterDatasetsDraw(chart) {
      const active = chart.getActiveElements?.() || [];
      if (!active.length) return;

      const a = active[0];
      const meta = chart.getDatasetMeta(a.datasetIndex);
      const el = meta?.data?.[a.index];
      if (!el) return;

      const area = chart.chartArea;
      const ctx = chart.ctx;

      ctx.save();
      ctx.lineWidth = 1;
      ctx.setLineDash([3,3]);
      ctx.strokeStyle = "rgba(255,255,255,0.22)";
      ctx.beginPath();
      ctx.moveTo(el.x, area.top);
      ctx.lineTo(el.x, area.bottom);
      ctx.stroke();
      ctx.restore();
    }
  };

  // Chapter 3 baseline at 100
  const baseline100 = {
    id: "baseline100",
    afterDraw(chart) {
      if (chart.$state !== "system") return;
      const area = chart.chartArea;
      const yScale = chart.scales?.y;
      if (!area || !yScale) return;

      const y = yScale.getPixelForValue(100);
      const ctx = chart.ctx;

      ctx.save();
      ctx.lineWidth = 1;
      ctx.setLineDash([4,4]);
      ctx.strokeStyle = "rgba(255,255,255,0.18)";
      ctx.beginPath();
      ctx.moveTo(area.left, y);
      ctx.lineTo(area.right, y);
      ctx.stroke();

      ctx.fillStyle = "rgba(255,255,255,0.55)";
      ctx.font = "12px system-ui";
      ctx.textBaseline = "bottom";
      ctx.fillText("2000 baseline (100)", area.left + 6, y - 4);
      ctx.restore();
    }
  };

  Chart.register(crosshair, baseline100);

  // ---------- chart ----------
  const canvas = document.getElementById("chart");
  const ctx = canvas.getContext("2d");

  const chart = new Chart(ctx, {
    type: "line",
    data: { labels: years.map(String), datasets: [] },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      animation: { duration: 120 },
      interaction: { mode: "nearest", intersect: false },
      plugins: {
        legend: { display: false },
        tooltip: { enabled: false } // no tooltips
      },
      elements: { line: { spanGaps: false } },
      scales: {
        x: {
          type: "category",
          ticks: {
            maxRotation: 0,
            color: "rgba(255,255,255,.85)",
            callback: function(value) {
              const year = Number(this.getLabelForValue(value));
              return year % 5 === 0 ? String(year) : "";
            }
          },
          grid: { color: "rgba(255,255,255,.08)" }
        },
        y: {
          position: "left",
          ticks: { color: "rgba(255,255,255,.85)" },
          grid: { color: "rgba(255,255,255,.08)" },
          title: { display: false, text: "" }
        },
        y2: {
          display: false,
          position: "right",
          ticks: { color: "rgba(255,255,255,.85)" },
          grid: { drawOnChartArea: false },
          title: { display: false, text: "" }
        }
      }
    }
  });

  // ---------- legend: filter ----------
  function setDatasetBaseColors(){
    chart.data.datasets.forEach(ds => {
      ds._baseBorderColor = ds.borderColor;
      ds._baseBackgroundColor = ds.backgroundColor;
    });
  }

  function setVisibilityFilter(diOrNull){
    chart.$filterDi = (diOrNull == null ? null : Number(diOrNull));
    chart.data.datasets.forEach((ds, i) => {
      ds.hidden = (chart.$filterDi != null && i !== chart.$filterDi);
    });
    chart.update("none");
    setActiveAtIndex(Number(slider.value));
  }

  function renderLegend(){
    legendEl.innerHTML = "";

    const allBtn = document.createElement("button");
    allBtn.className = "leg-btn active";
    allBtn.type = "button";
    allBtn.innerHTML = `<span class="swatch" style="background:rgba(255,255,255,.75)"></span><span>All</span>`;
    allBtn.addEventListener("click", () => {
      legendEl.querySelectorAll(".leg-btn").forEach(b => b.classList.remove("active"));
      allBtn.classList.add("active");
      setVisibilityFilter(null);
    });
    legendEl.appendChild(allBtn);

    chart.data.datasets.forEach((ds, i) => {
      const btn = document.createElement("button");
      btn.className = "leg-btn";
      btn.type = "button";
      btn.innerHTML = `<span class="swatch" style="background:${ds._baseBorderColor}"></span><span>${ds.label}</span>`;
      btn.addEventListener("click", () => {
        legendEl.querySelectorAll(".leg-btn").forEach(b => b.classList.remove("active"));
        btn.classList.add("active");
        setVisibilityFilter(i);
      });
      legendEl.appendChild(btn);
    });

    setVisibilityFilter(null);
  }

  // ---------- summary ----------
  function setSummary(i){
    const idx = Math.max(0, Math.min(years.length - 1, i|0));
    const year = years[idx];
    sumTitle.textContent = `Year: ${year}`;

    const rows = [];
    const visible = chart.data.datasets
      .map((ds, di) => ({ds, di}))
      .filter(x => chart.isDatasetVisible(x.di));

    if (chart.$state === "baseline"){
      const showTrips = visible.some(v => v.ds.label.startsWith("Trips"));
      const showPop = visible.some(v => v.ds.label === "Population");
      if (showTrips) rows.push({c:"rgba(255,90,90,.95)", t:`<span class="dim">Trips:</span> ${fmt2(tripsPer100[idx])} trips/100 people/day`});
      if (showPop) rows.push({c:"rgba(120,160,255,.85)", t:`<span class="dim">Population:</span> ${fmtInt(pop[idx])} people`});
      if (showTrips && showPop) rows.push({c:"rgba(255,255,255,.55)", t:`<span class="dim">Total rides:</span> ${fmtInt(total[idx])} rides/day`});

    } else if (chart.$state === "modes"){
      const railShareV = rail[idx] / (rail[idx] + bus[idx]) * 100;
      const busShareV = 100 - railShareV;

      const showRail = visible.some(v => v.ds.label.startsWith("Rail"));
      const showBus  = visible.some(v => v.ds.label === "Bus");

      if (showRail) rows.push({c:"rgba(92,108,255,.95)", t:`<span class="dim">Rail (MRT+LRT):</span> ${fmt1(railShareV)}% | ${fmtInt(rail[idx])} rides/day`});
      if (showBus)  rows.push({c:"rgba(255,170,60,.95)", t:`<span class="dim">Bus:</span> ${fmt1(busShareV)}% | ${fmtInt(bus[idx])} rides/day`});

    } else {
      const totalIdx = indexTo100(total)[idx];
      const railIdx  = indexTo100(rail)[idx];
      const busIdx   = indexTo100(bus)[idx];

      const showTotal = visible.some(v => v.ds.label === "Total rides");
      const showRail  = visible.some(v => v.ds.label === "Rail rides");
      const showBus   = visible.some(v => v.ds.label === "Bus rides");

      if (showTotal) rows.push({c:"rgba(255,90,90,.95)", t:`<span class="dim">Total rides:</span> ${fmt1(totalIdx)} (2000=100) | ${fmtInt(total[idx])} rides/day`});
      if (showRail)  rows.push({c:"rgba(92,108,255,.95)", t:`<span class="dim">Rail rides:</span> ${fmt1(railIdx)} (2000=100) | ${fmtInt(rail[idx])} rides/day`});
      if (showBus)   rows.push({c:"rgba(255,170,60,.95)", t:`<span class="dim">Bus rides:</span> ${fmt1(busIdx)} (2000=100) | ${fmtInt(bus[idx])} rides/day`});
    }

    sumBody.innerHTML = rows.map(r => `
      <div class="row">
        <span class="swatch" style="background:${r.c}"></span>
        <div>${r.t}</div>
      </div>
    `).join("");
  }

  // ---------- pin year (no tooltip) ----------
  function setActiveAtIndex(i){
    const idx = Math.max(0, Math.min(years.length - 1, i|0));
    slider.value = String(idx);
    yearPill.textContent = `Year: ${years[idx]}`;
    setSummary(idx);

    const visibleDs = chart.data.datasets
      .map((ds, di) => ({ds, di}))
      .filter(x => chart.isDatasetVisible(x.di));

    const active = visibleDs.map(v => ({ datasetIndex: v.di, index: idx }));
    chart.setActiveElements(active);
    chart.update("none");
  }

  slider.addEventListener("input", () => setActiveAtIndex(Number(slider.value)), { passive: true });

  // Click to jump
  canvas.addEventListener("click", (evt) => {
    const points = chart.getElementsAtEventForMode(evt, "nearest", { intersect:false }, true);
    if (!points.length) return;
    setActiveAtIndex(points[0].index);
  });

  // snap mousemove
  canvas.addEventListener("mousemove", (evt) => {
    const area = chart.chartArea;
    if (!area) return;

    const rect = canvas.getBoundingClientRect();
    const x = evt.clientX - rect.left;
    const y = evt.clientY - rect.top;

    if (x < area.left || x > area.right || y < area.top || y > area.bottom) return;

    const raw = chart.scales.x.getValueForPixel(x);
    const idx = Math.round(Number(raw));
    if (!Number.isFinite(idx)) return;

    const clamped = Math.max(0, Math.min(years.length - 1, idx));
    if (clamped !== Number(slider.value)) setActiveAtIndex(clamped);
  }, { passive: true });

  // ---------- states ----------
  function setState(stateId){
    chart.$state = stateId;

    // reset scales
    chart.options.scales.y2.display = false;
    chart.options.scales.y.stacked = false;
    chart.options.scales.x.stacked = false;
    chart.options.scales.y.min = undefined;
    chart.options.scales.y.max = undefined;
    chart.options.scales.y.title.display = false;
    chart.options.scales.y.title.text = "";
    chart.options.scales.y2.title.display = false;
    chart.options.scales.y2.title.text = "";

    if (stateId === "baseline"){
      titleEl.textContent = "Travel Intensity: Trips per 100 people per day";
      subtitleEl.textContent = "Red: trips/100 people/day. Blue: population (right axis).";

      const e = extent(tripsPer100);
      chart.options.scales.y.min = e.min;
      chart.options.scales.y.max = e.max;

      chart.options.scales.y.title.display = true;
      chart.options.scales.y.title.text = "Trips per 100 people per day";

      chart.options.scales.y2.display = true;
      chart.options.scales.y2.title.display = true;
      chart.options.scales.y2.title.text = "Population";

      chart.data.datasets = [
        {
          label: "Population",
          data: pop,
          yAxisID: "y2",
          tension: 0.25,
          borderColor: "rgba(120,160,255,.85)",
          backgroundColor: "rgba(120,160,255,.10)",
          borderDash: [4,4],
          fill: true,
          pointRadius: 3,
          pointHoverRadius: 8,
          hitRadius: 14,
          pointBackgroundColor: "rgba(120,160,255,0)",
          pointBorderColor: "rgba(120,160,255,0)"
        },
        {
          label: "Trips per 100 people per day",
          data: tripsPer100,
          yAxisID: "y",
          tension: 0.25,
          borderColor: "rgba(255,90,90,.95)",
          backgroundColor: "rgba(255,90,90,.10)",
          pointRadius: 3,
          pointHoverRadius: 6,
          hitRadius: 14,
          fill: false
        }
      ];
      setDatasetBaseColors();
    }

    if (stateId === "modes"){
      titleEl.textContent = "Mode Split: Bus vs Rail share";
      subtitleEl.textContent = "100% stacked share: MRT+LRT vs Bus. Bus has no misleading 100% stroke.";

      const railShare = rail.map((r,i)=> (r!=null && bus[i]!=null && (r+bus[i])!==0) ? (r/(r+bus[i]))*100 : null);
      const busShare  = railShare.map(v => (v==null ? null : 100 - v));

      chart.options.scales.y.stacked = true;
      chart.options.scales.x.stacked = true;
      chart.options.scales.y.min = 0;
      chart.options.scales.y.max = 100;
      chart.options.scales.y.title.display = true;
      chart.options.scales.y.title.text = "Share of public transport ridership (%)";

      chart.data.datasets = [
        {
          label: "Rail (MRT+LRT)",
          data: railShare,
          tension: 0.25,
          borderColor: "rgba(92,108,255,.95)",
          backgroundColor: "rgba(92,108,255,.18)",
          borderWidth: 2,
          pointRadius: 2,
          pointHoverRadius: 6,
          hitRadius: 16,
          fill: true
        },
        {
          label: "Bus",
          data: busShare,
          tension: 0.25,
          borderColor: "rgba(255,170,60,0)",
          backgroundColor: "rgba(255,170,60,.14)",
          borderWidth: 0,
          pointRadius: 2,
          pointHoverRadius: 6,
          hitRadius: 16,
          fill: true
        }
      ];
      setDatasetBaseColors();
    }

    if (stateId === "system"){
      titleEl.textContent = "Growth Race: Demand (2000 = 100)";
      subtitleEl.textContent = "Indexed growth since 2000. Total vs rail vs bus ridership.";

      chart.options.scales.y.title.display = true;
      chart.options.scales.y.title.text = "Index (2000 = 100)";

      const totalIdx = indexTo100(total);
      const railIdx  = indexTo100(rail);
      const busIdx   = indexTo100(bus);

      chart.data.datasets = [
        {
          label: "Total rides",
          data: totalIdx,
          tension: 0.25,
          borderColor: "rgba(255,90,90,.95)",      /* ✅ red */
          backgroundColor: "rgba(255,90,90,.10)",  /* ✅ soft red fill */
          pointRadius: 2,
          pointHoverRadius: 6,
          hitRadius: 14
        },
        {
          label: "Rail rides",
          data: railIdx,
          tension: 0.25,
          borderColor: "rgba(92,108,255,.95)",
          backgroundColor: "rgba(92,108,255,.12)",
          pointRadius: 2,
          pointHoverRadius: 6,
          hitRadius: 14
        },
        {
          label: "Bus rides",
          data: busIdx,
          tension: 0.25,
          borderColor: "rgba(255,170,60,.95)",
          backgroundColor: "rgba(255,170,60,.08)",
          pointRadius: 2,
          pointHoverRadius: 6,
          hitRadius: 14
        }
      ];
      setDatasetBaseColors();
    }

    chart.update();
    renderLegend();

    chart.$filterDi = null;
    chart.data.datasets.forEach(ds => ds.hidden = false);
    chart.update("none");

    setActiveAtIndex(Number(slider.value));
  }

  // ---------- tabs ----------
  const tabs = Array.from(document.querySelectorAll(".tab"));
  const panels = {
    baseline: document.getElementById("panel-baseline"),
    modes: document.getElementById("panel-modes"),
    system: document.getElementById("panel-system")
  };

  function activateTab(btn){
    const state = btn.dataset.state;
    tabs.forEach(b => b.setAttribute("aria-selected", b === btn ? "true" : "false"));
    Object.values(panels).forEach(p => p.classList.remove("active"));
    panels[state].classList.add("active");
    setState(state);
  }

  tabs.forEach(btn => btn.addEventListener("click", () => activateTab(btn)));

  // ---------- boot ----------
  yearPill.textContent = `Year: ${years[Number(slider.value)]}`;
  setState("baseline");

  window.app = { chart, setState, setActiveAtIndex, years };
})();
</script>
</body>
</html>
